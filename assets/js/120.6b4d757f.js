(window.webpackJsonp=window.webpackJsonp||[]).push([[120],{616:function(t,s,a){"use strict";a.r(s);var e=a(35),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"背景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[t._v("#")]),t._v(" 背景")]),t._v(" "),a("p",[t._v("问题来源：如果使用 webpack，比如运行 "),a("code",[t._v("npx webpack .")]),t._v(" 会在每次构建结束后控制台输出编译耗时。这时可能就会发出疑问，webpack 是如何计算编译时间的呢？")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("asset main.js 1.4 KiB [compared for emit] (name: main)\n./index.js 56 bytes [built] [code generated]\n./sum.js 41 bytes [built] [code generated]\nwebpack 5.74.0 compiled successfully in 75 ms\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("h2",{attrs:{id:"回答问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#回答问题"}},[t._v("#")]),t._v(" 回答问题")]),t._v(" "),a("ol",[a("li",[t._v("stats.endTime - stats.startTime")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cb39b131c468458ea10d5b5e725298e4~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[t._v("stats.toJson().time")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/88bb767b42df474d8dec0a2d67b718c0~tplv-k3u1fbpfcp-watermark.image?",alt:"image.png"}})]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/206276c180c7418cae731b38b9bad9b0~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),t._v(" "),a("blockquote",[a("p",[t._v("文章只对第一种方式获取到编译时间的过程进行了详述，另一种留给读者实践验证~")])]),t._v(" "),a("h2",{attrs:{id:"查看源码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看源码"}},[t._v("#")]),t._v(" 查看源码")]),t._v(" "),a("h3",{attrs:{id:"思路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#思路"}},[t._v("#")]),t._v(" 思路")]),t._v(" "),a("p",[t._v("思路：从后往前分析，从结果出发，看调用堆栈")]),t._v(" "),a("h3",{attrs:{id:"调试过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#调试过程"}},[t._v("#")]),t._v(" 调试过程")]),t._v(" "),a("p",[t._v("说明：以下调试代码是使用 Webpack 的 Node.js API 实现，具体使用可参考官方文档。")]),t._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://webpack.docschina.org/api/node/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://webpack.docschina.org/api/node/"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://webpack.docschina.org/api/node/#run",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://webpack.docschina.org/api/node/#run"),a("OutboundLink")],1)])]),t._v(" "),a("p",[a("strong",[t._v("首先准备代码")])]),t._v(" "),a("p",[t._v("build.js")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("const webpack = require('webpack')\nconst path = require('path')\n\nfunction build1() {\n  return webpack({\n    entry: {\n      index: './index.js',\n      test: './test.js'\n    },\n    output: {\n      path: path.resolve(__dirname, 'build'),\n      filename: '[name].js'\n    },\n    mode: 'none'\n  })\n}\n\nbuild1()\n  .run((err, stat) => {\n    const startTime = stat.startTime\n    const endTime = stat.endTime\n    console.log(\"构建时间\", endTime - startTime);\n    // console.log(\"构建时间\", stat.endTime - stat.startTime);\n  })\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br")])]),a("p",[t._v("index.js")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("console.log('index---');\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("test.js")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("function test() {\n  console.log('test---');\n}\n\ntest()\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[a("strong",[t._v("开始调试")])]),t._v(" "),a("p",[t._v("（1）因为我们知道 .run 内的回调能拿到 err 和 stat 参数，那就将断点先打到回调函数体内，如这里的第 20 行，通过调用堆栈去找 stat。在 JavaScript Debug Terminal 执行 node build.js，代码运行到断点处，这时不要着急，看左侧的调用堆栈。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc36c981cf2f439e9c982ba53e0c3ef0~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),t._v(" "),a("p",[t._v("（2）点击堆栈中第二行，到了 callback 的调用位置，明确目标，我们要找到 stats 是怎么传递的，于是关注到 callback 在 finalCallback 函数体内，这个函数接收到 stats 参数，所以要去找这个函数的调用位置；")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/07ffe627dcc44b9b8071ad467d6e6c68~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),t._v(" "),a("p",[t._v("（3）继续点击堆栈第三行，这时就来到调用 finalCallback 的位置，这里传递了 stats")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/420214b7844c43af87f308925e7e9376~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),t._v(" "),a("p",[t._v("（4）这时可以不用在堆栈找了，因为我们已经定位到位置，现在需要去搜索 stats 变量在哪里定义和赋值的")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/babfd659efa64e4b9574c35e9286a289~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),t._v(" "),a("p",[t._v("这里发现有一个 startTime，再去找它的声明和赋值的位置")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c3e51b61f0174c098a13aae28edf30de~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),t._v(" "),a("p",[t._v("（5）在（4）的分析中，有一个关键的位置 new Stats(compilation)，可以跟进去看一下，ctrl+click")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f12a97e49a0b47829cff4f0d89a3c01d~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),t._v(" "),a("p",[t._v("进到了 Stats.js 中，猜想是通过这两个方法拿到 startTime/endTime")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7e897b8ae27465787e4e854dd17ae03~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),t._v(" "),a("p",[t._v("（6）现在已经比较清晰了，可以在以上分析中的关键代码中打断点，然后执行，进去看看每个断点位置的执行情况")]),t._v(" "),a("p",[t._v("（7）还有一个简单的验证方式，直接在 20 行打断点，然后单步调试")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc7362d62e0d445296d4e74cd9a89391~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),t._v(" "),a("p",[t._v("这样直接进到 Stats.js 中")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3a920886e3742f4b95fce536779a5b4~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[t._v("#")]),t._v(" 小结")]),t._v(" "),a("p",[t._v("实际上就是在开始编译和编译结束的时候，通过 Date.now() 获取对应的时间戳，放在了 Stats 对象上（其实还是通过 compilation 拿到的）")]),t._v(" "),a("p",[t._v("Compiler.js")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("// ...\nconst startTime = Date.now() // 获取开始编译时间\n// ...\ncompilation.startTime = startTime;\ncompilation.endTime = Date.now() // 获取编译结束时间\n// ...\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("h2",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),a("ul",[a("li",[a("p",[a("a",{attrs:{href:"https://webpack.js.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://webpack.js.org/"),a("OutboundLink")],1)])]),t._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://webpack.docschina.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://webpack.docschina.org/"),a("OutboundLink")],1)])]),t._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://webpack.docschina.org/api/stats",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://webpack.docschina.org/api/stats"),a("OutboundLink")],1)])]),t._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://github.com/shfshanyue/node-examples",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/shfshanyue/node-examples"),a("OutboundLink")],1)])])])])}),[],!1,null,null,null);s.default=n.exports}}]);