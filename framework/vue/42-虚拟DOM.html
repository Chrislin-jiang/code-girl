<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>虚拟 DOM | 窗边的anini</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="apple-touch-icon" href="/code-girl/apple-touch-icon.png">
    <link rel="icon" href="/code-girl/favicon.ico">
    <link rel="manifest" href="/code-girl/manifest.json">
    <meta name="description" content="路阻且长，行则将至">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/code-girl/assets/css/0.styles.95a048e1.css" as="style"><link rel="preload" href="/code-girl/assets/js/app.223cac8a.js" as="script"><link rel="preload" href="/code-girl/assets/js/2.d9d6c442.js" as="script"><link rel="preload" href="/code-girl/assets/js/75.02b082d9.js" as="script"><link rel="preload" href="/code-girl/assets/js/3.a7958272.js" as="script"><link rel="prefetch" href="/code-girl/assets/js/10.6dff095b.js"><link rel="prefetch" href="/code-girl/assets/js/100.762e2842.js"><link rel="prefetch" href="/code-girl/assets/js/101.64a0cf66.js"><link rel="prefetch" href="/code-girl/assets/js/102.2217049f.js"><link rel="prefetch" href="/code-girl/assets/js/103.1842d49a.js"><link rel="prefetch" href="/code-girl/assets/js/104.3fec0b20.js"><link rel="prefetch" href="/code-girl/assets/js/105.3fc6871a.js"><link rel="prefetch" href="/code-girl/assets/js/106.7f36687b.js"><link rel="prefetch" href="/code-girl/assets/js/107.486b3234.js"><link rel="prefetch" href="/code-girl/assets/js/108.80beb728.js"><link rel="prefetch" href="/code-girl/assets/js/109.640498d1.js"><link rel="prefetch" href="/code-girl/assets/js/11.864b3458.js"><link rel="prefetch" href="/code-girl/assets/js/110.1783d669.js"><link rel="prefetch" href="/code-girl/assets/js/111.4d4fc3cb.js"><link rel="prefetch" href="/code-girl/assets/js/112.a0684edb.js"><link rel="prefetch" href="/code-girl/assets/js/113.27984fb4.js"><link rel="prefetch" href="/code-girl/assets/js/114.6bd5174d.js"><link rel="prefetch" href="/code-girl/assets/js/115.c7f943c0.js"><link rel="prefetch" href="/code-girl/assets/js/116.e57131fe.js"><link rel="prefetch" href="/code-girl/assets/js/117.9c804ec4.js"><link rel="prefetch" href="/code-girl/assets/js/118.edff26ca.js"><link rel="prefetch" href="/code-girl/assets/js/119.30d65181.js"><link rel="prefetch" href="/code-girl/assets/js/12.e2c5e2b9.js"><link rel="prefetch" href="/code-girl/assets/js/120.6b4d757f.js"><link rel="prefetch" href="/code-girl/assets/js/121.f7fcbc78.js"><link rel="prefetch" href="/code-girl/assets/js/122.4aa2b0e2.js"><link rel="prefetch" href="/code-girl/assets/js/123.6cccb225.js"><link rel="prefetch" href="/code-girl/assets/js/124.461658ee.js"><link rel="prefetch" href="/code-girl/assets/js/125.e4e3bfb3.js"><link rel="prefetch" href="/code-girl/assets/js/126.36318c24.js"><link rel="prefetch" href="/code-girl/assets/js/127.88d452f6.js"><link rel="prefetch" href="/code-girl/assets/js/128.a7a76580.js"><link rel="prefetch" href="/code-girl/assets/js/129.638a64be.js"><link rel="prefetch" href="/code-girl/assets/js/13.559f9d70.js"><link rel="prefetch" href="/code-girl/assets/js/130.ea7486c7.js"><link rel="prefetch" href="/code-girl/assets/js/131.c1353a3b.js"><link rel="prefetch" href="/code-girl/assets/js/132.dfac7878.js"><link rel="prefetch" href="/code-girl/assets/js/133.dc9b873d.js"><link rel="prefetch" href="/code-girl/assets/js/134.c302bddb.js"><link rel="prefetch" href="/code-girl/assets/js/135.39e2a87e.js"><link rel="prefetch" href="/code-girl/assets/js/136.8a5ae2bf.js"><link rel="prefetch" href="/code-girl/assets/js/137.22d001bf.js"><link rel="prefetch" href="/code-girl/assets/js/138.55726c71.js"><link rel="prefetch" href="/code-girl/assets/js/139.0210bc53.js"><link rel="prefetch" href="/code-girl/assets/js/14.5e009f11.js"><link rel="prefetch" href="/code-girl/assets/js/140.509b5170.js"><link rel="prefetch" href="/code-girl/assets/js/141.74ee1578.js"><link rel="prefetch" href="/code-girl/assets/js/142.d4920133.js"><link rel="prefetch" href="/code-girl/assets/js/143.3385dfda.js"><link rel="prefetch" href="/code-girl/assets/js/144.4e27226c.js"><link rel="prefetch" href="/code-girl/assets/js/145.efe5b96e.js"><link rel="prefetch" href="/code-girl/assets/js/146.f3492d60.js"><link rel="prefetch" href="/code-girl/assets/js/147.ec91f79f.js"><link rel="prefetch" href="/code-girl/assets/js/148.be444079.js"><link rel="prefetch" href="/code-girl/assets/js/149.f37221cf.js"><link rel="prefetch" href="/code-girl/assets/js/15.6e589384.js"><link rel="prefetch" href="/code-girl/assets/js/150.8d4e8059.js"><link rel="prefetch" href="/code-girl/assets/js/151.bcdffd6e.js"><link rel="prefetch" href="/code-girl/assets/js/152.84465229.js"><link rel="prefetch" href="/code-girl/assets/js/153.91078e02.js"><link rel="prefetch" href="/code-girl/assets/js/16.0fed92e7.js"><link rel="prefetch" href="/code-girl/assets/js/17.9c030402.js"><link rel="prefetch" href="/code-girl/assets/js/18.f9fbdf6b.js"><link rel="prefetch" href="/code-girl/assets/js/19.6a271721.js"><link rel="prefetch" href="/code-girl/assets/js/20.c6674746.js"><link rel="prefetch" href="/code-girl/assets/js/21.b955bb32.js"><link rel="prefetch" href="/code-girl/assets/js/22.e5228c97.js"><link rel="prefetch" href="/code-girl/assets/js/23.71ea388c.js"><link rel="prefetch" href="/code-girl/assets/js/24.808982f5.js"><link rel="prefetch" href="/code-girl/assets/js/25.76814161.js"><link rel="prefetch" href="/code-girl/assets/js/26.b63d9e73.js"><link rel="prefetch" href="/code-girl/assets/js/27.e15e5c2e.js"><link rel="prefetch" href="/code-girl/assets/js/28.c2a59798.js"><link rel="prefetch" href="/code-girl/assets/js/29.9a2b570c.js"><link rel="prefetch" href="/code-girl/assets/js/30.6ca91072.js"><link rel="prefetch" href="/code-girl/assets/js/31.91b0e21f.js"><link rel="prefetch" href="/code-girl/assets/js/32.c94f310f.js"><link rel="prefetch" href="/code-girl/assets/js/33.fc839b51.js"><link rel="prefetch" href="/code-girl/assets/js/34.3751df10.js"><link rel="prefetch" href="/code-girl/assets/js/35.c2c77ae2.js"><link rel="prefetch" href="/code-girl/assets/js/36.93f284a9.js"><link rel="prefetch" href="/code-girl/assets/js/37.89561c9b.js"><link rel="prefetch" href="/code-girl/assets/js/38.17f9d495.js"><link rel="prefetch" href="/code-girl/assets/js/39.4c4f99f2.js"><link rel="prefetch" href="/code-girl/assets/js/4.ec50c956.js"><link rel="prefetch" href="/code-girl/assets/js/40.9fc88976.js"><link rel="prefetch" href="/code-girl/assets/js/41.e61ad491.js"><link rel="prefetch" href="/code-girl/assets/js/42.d5e851fd.js"><link rel="prefetch" href="/code-girl/assets/js/43.f91de7d4.js"><link rel="prefetch" href="/code-girl/assets/js/44.bbbf9dd6.js"><link rel="prefetch" href="/code-girl/assets/js/45.7c6c8d2d.js"><link rel="prefetch" href="/code-girl/assets/js/46.ae3141ff.js"><link rel="prefetch" href="/code-girl/assets/js/47.024b5379.js"><link rel="prefetch" href="/code-girl/assets/js/48.eceed5ae.js"><link rel="prefetch" href="/code-girl/assets/js/49.ae2fea85.js"><link rel="prefetch" href="/code-girl/assets/js/5.dfe2243a.js"><link rel="prefetch" href="/code-girl/assets/js/50.301af76e.js"><link rel="prefetch" href="/code-girl/assets/js/51.31fefa5c.js"><link rel="prefetch" href="/code-girl/assets/js/52.685c0e48.js"><link rel="prefetch" href="/code-girl/assets/js/53.0b2fa81e.js"><link rel="prefetch" href="/code-girl/assets/js/54.99ac51d7.js"><link rel="prefetch" href="/code-girl/assets/js/55.9373c9b7.js"><link rel="prefetch" href="/code-girl/assets/js/56.ce740235.js"><link rel="prefetch" href="/code-girl/assets/js/57.5cdca5a3.js"><link rel="prefetch" href="/code-girl/assets/js/58.ac12bcd8.js"><link rel="prefetch" href="/code-girl/assets/js/59.ac882a46.js"><link rel="prefetch" href="/code-girl/assets/js/6.29b05f97.js"><link rel="prefetch" href="/code-girl/assets/js/60.6b160d40.js"><link rel="prefetch" href="/code-girl/assets/js/61.701fddf1.js"><link rel="prefetch" href="/code-girl/assets/js/62.b6d2820d.js"><link rel="prefetch" href="/code-girl/assets/js/63.5ac71760.js"><link rel="prefetch" href="/code-girl/assets/js/64.0215df8b.js"><link rel="prefetch" href="/code-girl/assets/js/65.132779cb.js"><link rel="prefetch" href="/code-girl/assets/js/66.98fdeb68.js"><link rel="prefetch" href="/code-girl/assets/js/67.ad03b84c.js"><link rel="prefetch" href="/code-girl/assets/js/68.bc22219a.js"><link rel="prefetch" href="/code-girl/assets/js/69.8e651471.js"><link rel="prefetch" href="/code-girl/assets/js/7.203f8a81.js"><link rel="prefetch" href="/code-girl/assets/js/70.7f83e00a.js"><link rel="prefetch" href="/code-girl/assets/js/71.94428fbf.js"><link rel="prefetch" href="/code-girl/assets/js/72.2357247e.js"><link rel="prefetch" href="/code-girl/assets/js/73.c2c211f1.js"><link rel="prefetch" href="/code-girl/assets/js/74.2a5c0119.js"><link rel="prefetch" href="/code-girl/assets/js/76.36db4742.js"><link rel="prefetch" href="/code-girl/assets/js/77.757af03d.js"><link rel="prefetch" href="/code-girl/assets/js/78.cc33d724.js"><link rel="prefetch" href="/code-girl/assets/js/79.b80f442c.js"><link rel="prefetch" href="/code-girl/assets/js/8.bbd9654c.js"><link rel="prefetch" href="/code-girl/assets/js/80.37762922.js"><link rel="prefetch" href="/code-girl/assets/js/81.809bb7a7.js"><link rel="prefetch" href="/code-girl/assets/js/82.22c37bdb.js"><link rel="prefetch" href="/code-girl/assets/js/83.a6b36be8.js"><link rel="prefetch" href="/code-girl/assets/js/84.61c02917.js"><link rel="prefetch" href="/code-girl/assets/js/85.c87af2f4.js"><link rel="prefetch" href="/code-girl/assets/js/86.4c0db8ed.js"><link rel="prefetch" href="/code-girl/assets/js/87.fb49738a.js"><link rel="prefetch" href="/code-girl/assets/js/88.2cc8998d.js"><link rel="prefetch" href="/code-girl/assets/js/89.49572659.js"><link rel="prefetch" href="/code-girl/assets/js/9.87488fa6.js"><link rel="prefetch" href="/code-girl/assets/js/90.cf81f66d.js"><link rel="prefetch" href="/code-girl/assets/js/91.e2744e17.js"><link rel="prefetch" href="/code-girl/assets/js/92.64c6d59a.js"><link rel="prefetch" href="/code-girl/assets/js/93.43c41cc1.js"><link rel="prefetch" href="/code-girl/assets/js/94.4073f420.js"><link rel="prefetch" href="/code-girl/assets/js/95.5995677b.js"><link rel="prefetch" href="/code-girl/assets/js/96.81d8b6ef.js"><link rel="prefetch" href="/code-girl/assets/js/97.5e4be9f7.js"><link rel="prefetch" href="/code-girl/assets/js/98.f6c9cc15.js"><link rel="prefetch" href="/code-girl/assets/js/99.23d4f0b4.js">
    <link rel="stylesheet" href="/code-girl/assets/css/0.styles.95a048e1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/code-girl/" class="home-link router-link-active"><!----> <span class="site-name">窗边的anini</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/code-girl/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/code-girl/guide/" class="nav-link">
  导航
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-girl/frontend/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/frontend/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/frontend/js/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/frontend/browser/" class="nav-link">
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/frontend/webpack/" class="nav-link">
  Webpack
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-girl/framework/vue/" class="nav-link router-link-active">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/framework/react/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/framework/project/" class="nav-link">
  项目
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-girl/backend/nodejs/" class="nav-link">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/backend/koa/" class="nav-link">
  Koa
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/backend/mongodb/" class="nav-link">
  MongoDB
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机" class="dropdown-title"><span class="title">计算机</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机" class="mobile-dropdown-title"><span class="title">计算机</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-girl/computer/basis/" class="nav-link">
  计算机组成原理
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/computer/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/computer/network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/computer/database/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/computer/design-mode/" class="nav-link">
  JavaScript设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-girl/algorithms/data-structures/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/algorithms/algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/algorithms/exercise/" class="nav-link">
  练习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-girl/more/growth/" class="nav-link">
  面经
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/more/library/" class="nav-link">
  三味书屋
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/more/time/" class="nav-link">
  点滴记录
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/more/fighting/" class="nav-link">
  阳光
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/more/exercise/" class="nav-link">
  程序媛必修
</a></li></ul></div></div> <a href="https://github.com/Chrislin-jiang/code-girl" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/code-girl/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/code-girl/guide/" class="nav-link">
  导航
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-girl/frontend/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/frontend/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/frontend/js/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/frontend/browser/" class="nav-link">
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/frontend/webpack/" class="nav-link">
  Webpack
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-girl/framework/vue/" class="nav-link router-link-active">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/framework/react/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/framework/project/" class="nav-link">
  项目
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-girl/backend/nodejs/" class="nav-link">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/backend/koa/" class="nav-link">
  Koa
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/backend/mongodb/" class="nav-link">
  MongoDB
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机" class="dropdown-title"><span class="title">计算机</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机" class="mobile-dropdown-title"><span class="title">计算机</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-girl/computer/basis/" class="nav-link">
  计算机组成原理
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/computer/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/computer/network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/computer/database/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/computer/design-mode/" class="nav-link">
  JavaScript设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-girl/algorithms/data-structures/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/algorithms/algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/algorithms/exercise/" class="nav-link">
  练习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-girl/more/growth/" class="nav-link">
  面经
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/more/library/" class="nav-link">
  三味书屋
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/more/time/" class="nav-link">
  点滴记录
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/more/fighting/" class="nav-link">
  阳光
</a></li><li class="dropdown-item"><!----> <a href="/code-girl/more/exercise/" class="nav-link">
  程序媛必修
</a></li></ul></div></div> <a href="https://github.com/Chrislin-jiang/code-girl" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>VUE</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/code-girl/framework/vue/" aria-current="page" class="sidebar-link">首页</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/code-girl/framework/vue/11-基础知识.html" class="sidebar-link">Vue.js 学习笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>生态系统</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/code-girl/framework/vue/21-Vuex.html" class="sidebar-link">Vuex</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue.js 原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/code-girl/framework/vue/41-数据绑定.html" class="sidebar-link">数据绑定</a></li><li><a href="/code-girl/framework/vue/42-虚拟DOM.html" class="active sidebar-link">虚拟 DOM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#_1-virtual-dom是什么" class="sidebar-link">1. Virtual DOM是什么</a></li><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#_2-为什么要用-vdom" class="sidebar-link">2. 为什么要用 vdom</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#_2-1-vdom-存在的必要" class="sidebar-link">2.1 vdom 存在的必要</a></li></ul></li><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#_3-借用-snabbdom-的思想实现vdom" class="sidebar-link">3. 借用 snabbdom 的思想实现vdom</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#_3-1-介绍snabbdom" class="sidebar-link">3.1 介绍snabbdom</a></li><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#_3-2-用-h-方法去实现简单的-dom-节点" class="sidebar-link">3.2 用 h 方法去实现简单的 dom 节点</a></li><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#_3-3-diff算法" class="sidebar-link">3.3 diff算法</a></li></ul></li><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#_4-从-snabbdom-源码中看-vdom-的实现" class="sidebar-link">4. 从 snabbdom 源码中看 vdom 的实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#snabbdom-js结构总览" class="sidebar-link">snabbdom.js结构总览</a></li><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#vnode-ts" class="sidebar-link">vnode.ts</a></li><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#tovnode-ts" class="sidebar-link">tovnode.ts</a></li><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#h-ts" class="sidebar-link">h.ts</a></li><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#snabbdom-ts" class="sidebar-link">snabbdom.ts</a></li></ul></li><li class="sidebar-sub-header"><a href="/code-girl/framework/vue/42-虚拟DOM.html#_5-小结" class="sidebar-link">5. 小结</a></li></ul></li><li><a href="/code-girl/framework/vue/43-模板编译.html" class="sidebar-link">模板编译</a></li><li><a href="/code-girl/framework/vue/44-整体流程.html" class="sidebar-link">整体流程</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-virtual-dom是什么"><a href="#_1-virtual-dom是什么" class="header-anchor">#</a> 1. Virtual DOM是什么</h2> <p>Virtual DOM 是对 DOM 的抽象,本质上是 JavaScrip t对象,这个对象就是更加轻量级的对 DOM 的描述.</p> <p>虚拟 DOM(Virtual DOM) 的简称为 vdom。</p> <p>简单来说，vdom 指的是用 JS 模拟的 DOM 结构，将 DOM 变化的对比放在 JS 层来做。</p> <p>如下DOM结构:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Item1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Item2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>映射成 vdom 就是这样:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 用JS模拟这个DOM</span>
<span class="token punctuation">{</span>
	tag<span class="token operator">:</span> <span class="token string">'ul'</span><span class="token punctuation">,</span>
	attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
		id<span class="token operator">:</span> <span class="token string">'list'</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
			tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span>
			attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
				className<span class="token operator">:</span> <span class="token string">'item'</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Item 1'</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span>
			attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
				className<span class="token operator">:</span> <span class="token string">'item'</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Item 2'</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="_2-为什么要用-vdom"><a href="#_2-为什么要用-vdom" class="header-anchor">#</a> 2. 为什么要用 vdom</h2> <h3 id="_2-1-vdom-存在的必要"><a href="#_2-1-vdom-存在的必要" class="header-anchor">#</a> 2.1 vdom 存在的必要</h3> <p><strong>在开发中遇到的问题</strong></p> <ol><li><p>DOM操作是‘昂贵’的，JS运行效率高</p></li> <li><p>尽量减少 DOM 操作，而不是‘推到重来’</p></li> <li><p>项目越复杂，影响越严重</p></li></ol> <p><strong>解决</strong></p> <ul><li>vdom 在一定程度上可解决上面所述问题</li></ul> <p>如果想要实现一个vdom，大概过程应该有以下三步：</p> <ul><li>compile，如何把真实 DOM 编译成 vnode。</li> <li>diff，我们要如何知道 oldVnode 和 newVnode 之间有什么变化。</li> <li>patch， 如果把这些变化用打补丁的方式更新到真实 dom 上去。</li></ul> <h2 id="_3-借用-snabbdom-的思想实现vdom"><a href="#_3-借用-snabbdom-的思想实现vdom" class="header-anchor">#</a> 3. 借用 snabbdom 的思想实现vdom</h2> <h3 id="_3-1-介绍snabbdom"><a href="#_3-1-介绍snabbdom" class="header-anchor">#</a> 3.1 介绍snabbdom</h3> <p>vue 在官方文档中提到与 react 的渲染性能对比中，因为其使用了 snabbdom 而有更优异的性能。</p> <p>JavaScript 开销直接与求算必要 DOM 操作的机制相关。尽管 Vue 和 React 都使用了 Virtual Dom 实现这一点，但 Vue 的 Virtual Dom 实现（参考 snabbdom.js）是更加轻量化的，因此也就比 React 的实现更高效。</p> <p>snabbdom 是一个简易的实现 vdom 功能的库，相比vue、react，对于 vdom 这块更加简易，适合我们学习 vdom。</p> <p>vdom 里面有两个核心的api，一个是h函数，一个是patch函数，前者用来生成vdom对象，后者的功能在于做vdom的比对和将vdom挂载到真实DOM上。</p> <p>简单介绍一下这两个函数的用法:</p> <ul><li>h('标签名', {属性}, [子元素])</li> <li>h('标签名', {属性}, [文本])</li> <li>patch(container, vnode) container为容器DOM元素</li> <li>patch(vnode, newVnode)</li></ul> <p>这是 <a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener noreferrer">snabbdom<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 给出的一个示例：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> snabbdom <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> patch <span class="token operator">=</span> snabbdom<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token comment">// Init patch function with chosen modules</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/modules/class'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">,</span> <span class="token comment">// makes it easy to toggle classes</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/modules/props'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">,</span> <span class="token comment">// for setting properties on DOM elements</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/modules/style'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">,</span> <span class="token comment">// handles styling on elements with support for animations</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/modules/eventlisteners'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">,</span> <span class="token comment">// attaches event listeners</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> h <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/h'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span> <span class="token comment">// helper function for creating vnodes</span>

<span class="token keyword">var</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div#container.two.classes'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>on<span class="token operator">:</span> <span class="token punctuation">{</span>click<span class="token operator">:</span> someFn<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>style<span class="token operator">:</span> <span class="token punctuation">{</span>fontWeight<span class="token operator">:</span> <span class="token string">'bold'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'This is bold'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">' and this is just normal text'</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>props<span class="token operator">:</span> <span class="token punctuation">{</span>href<span class="token operator">:</span> <span class="token string">'/foo'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'I\'ll take you places!'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Patch into empty DOM element – this modifies the DOM as a side effect</span>
<span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> newVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div#container.two.classes'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>on<span class="token operator">:</span> <span class="token punctuation">{</span>click<span class="token operator">:</span> anotherEventHandler<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>style<span class="token operator">:</span> <span class="token punctuation">{</span>fontWeight<span class="token operator">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span> fontStyle<span class="token operator">:</span> <span class="token string">'italic'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'This is now italic type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">' and this is still just normal text'</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>props<span class="token operator">:</span> <span class="token punctuation">{</span>href<span class="token operator">:</span> <span class="token string">'/bar'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'I\'ll take you places!'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Second `patch` invocation</span>
<span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Snabbdom efficiently updates the old view to the new state</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>其中 h方法 是创建一个vnode，即虚拟节点，定义一个 div，有一个 id 名 container，两个类名 two 和 classes，绑定一个 click 事件 someFn 方法，后面跟着一个数组，数组中有3个元素：</p> <p>第一个用 h方法返回的，一个span，有 font-weight 样式，和文本内容 This is bold
第二个元素就是一个文本字符串：and this is just normal text
第三个元素是一个 a元素，有一个属性 href 链接，后面是 a 标签文本</p> <p>第一个 patch 方法是将 vnode 放入到空的 container 中</p> <p>newVnode是返回一个新的node，</p> <p>然后第二个patch是将前后两个node进行一个对比，找出区别，只更新需要改动的内容，其他不更新的内容不更新，这样做到尽可能少的操作DOM。</p> <h3 id="_3-2-用-h-方法去实现简单的-dom-节点"><a href="#_3-2-用-h-方法去实现简单的-dom-节点" class="header-anchor">#</a> 3.2 用 h 方法去实现简单的 dom 节点</h3> <p>// 真实的HTML DOM结构</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Item1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Item2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>用h方法表示这个dom节点：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul#list'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li.item'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Item 1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li.item'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Item 2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_3-3-diff算法"><a href="#_3-3-diff算法" class="header-anchor">#</a> 3.3 diff算法</h3> <p><strong>virtual dom为何用diff算法？</strong></p> <p>DOM操作是昂贵的，应该尽可能减少DOM操作</p> <p>找出本次必须更新的节点，其他的不用更新</p> <p>这个“找出”的过程，就需要diff算法</p> <p>一句话，virtual dom中应用diff算法是为了找出需要更新的节点</p> <p>Virtual DOM 的 diff才是整个Virtual DOM 中最难理解也最核心的部分,diff的目的就是比较新旧Virtual DOM Tree找出差异并更新.</p> <p>可见diff是直接影响Virtual DOM 性能的关键部分.</p> <p>要比较Virtual DOM Tree的差异,理论上的时间复杂度高达O(n^3),这是一个奇高无比的时间复杂度,很显然选择这种低效的算法是无法满足我们对程序性能的基本要求的.</p> <p>好在我们实际开发中,很少会出现跨层级的 DOM 变更,通常情况下的 DOM 变更是同级的,因此在现代的各种 Virtual DOM库都是只比较同级差异,在这种情况下我们的时间复杂度是O(n).</p> <p><img src="https://img2020.cnblogs.com/blog/1908783/202003/1908783-20200328095200392-2047420771.png" alt="diff"></p> <p><strong>diff算法实现流程</strong></p> <p>diff的实现过程就是 patch(container, vnode) 和 - patch(vnode, newVnode)</p> <p>diff的实现的核心就是 createElement 和 updateChildren</p> <p>patch(container, vnode)</p> <p>初始化加载，直接将 vnode 节点打包渲染到一个空的容器 container 中</p> <p>patch(vnode, newVnode)</p> <p>文章开头可以看到，用JS去模拟一个简单的DOM节点
真实的HTML DOM结构</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Item1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Item2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>映射成 vdom 就是这样:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 用JS模拟这个DOM</span>
<span class="token punctuation">{</span>
	tag<span class="token operator">:</span> <span class="token string">'ul'</span><span class="token punctuation">,</span>
	attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
		id<span class="token operator">:</span> <span class="token string">'list'</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
			tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span>
			attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
				className<span class="token operator">:</span> <span class="token string">'item'</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Item 1'</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span>
			attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
				className<span class="token operator">:</span> <span class="token string">'item'</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Item 2'</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>那么模拟完了之后，怎么将模拟的JS进行转化为真实的DOM的呢？</p> <p>这个转化过程可以用这样一个 createElement 函数来描述：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">createElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> tag <span class="token operator">=</span> vnode<span class="token punctuation">.</span>tag<span class="token punctuation">;</span>
  <span class="token keyword">let</span> attrs <span class="token operator">=</span> vnode<span class="token punctuation">.</span>attrs <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> children <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//创建元素</span>
  <span class="token keyword">let</span> elem <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//属性</span>
  <span class="token keyword">let</span> attrName<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>attrName <span class="token keyword">in</span> attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>attrs<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>attrName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      elem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>attrName<span class="token punctuation">,</span> attrs<span class="token punctuation">[</span>attrName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//子元素</span>
  children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">childVnode</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//给elem添加子元素</span>
    elem<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">createElement</span><span class="token punctuation">(</span>childVnode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">//返回真实的dom元素</span>
  <span class="token keyword">return</span> elem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>当我们修改子节点，如下操作后，就要用到 patch(vnode, newVnode)</p> <p>patch(vnode, newVnode)
数据改变后，patch对比老数据 vnode 和新数据 newVnode</p> <p>真实的HTML DOM结构</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>list<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>item<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>Item 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>item<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>Item 22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>item<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>Item 3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>JS模拟这个DOM</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    tag<span class="token operator">:</span> <span class="token string">'ul'</span><span class="token punctuation">,</span>
    attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
        id<span class="token operator">:</span> <span class="token string">'list'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span>
          attrs<span class="token operator">:</span> <span class="token punctuation">{</span>className<span class="token operator">:</span> <span class="token string">'item'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Item 1'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span>
          attrs<span class="token operator">:</span> <span class="token punctuation">{</span>className<span class="token operator">:</span> <span class="token string">'item'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Item 22'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          tag<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span>
          attrs<span class="token operator">:</span> <span class="token punctuation">{</span>className<span class="token operator">:</span> <span class="token string">'item'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Item 3'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>这个转化过程，其实就是遍历子节点，然后找出区别，如下面的方法 updateChildren:</p> <p>那么我们接下来需要实现一个函数--updateChildren,并在里面进行具体的diff运算。</p> <p>用简易diff算法做更新操作:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> newVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> children <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> newChildren <span class="token operator">=</span> newVnode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">childVnode<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newChildVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>childVnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> newChildVNode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//深层次对比, 递归过程</span>
      <span class="token function">updateChildren</span><span class="token punctuation">(</span>childVnode<span class="token punctuation">,</span> newChildVNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//替换</span>
      <span class="token function">replaceNode</span><span class="token punctuation">(</span>childVnode<span class="token punctuation">,</span> newChildVNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>这部分内容是借用 snabbdom 的思想去实现 vdom, 其中 diff算法 比较简单，当我们对这个思想有了基本的掌握，就可以从 snabbdom 源码中看 vdom 的实现，也就是下一章节的内容。</p> <h2 id="_4-从-snabbdom-源码中看-vdom-的实现"><a href="#_4-从-snabbdom-源码中看-vdom-的实现" class="header-anchor">#</a> 4. 从 snabbdom 源码中看 vdom 的实现</h2> <h3 id="snabbdom-js结构总览"><a href="#snabbdom-js结构总览" class="header-anchor">#</a> snabbdom.js结构总览</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>src
├── helpers     
│   └── attachto.ts # 定义了AttachData，VNodeDataWithAttach ，VNodeWithAttachData 等数据结构
├── modules # 该文件夹中主要存放一些在更新dom差异的时候需要的操作     
│   ├── attributes.ts # 在vnode更新的时候，更新dom中的attrs操作。
│   ├── class.ts  # 在vnode更新的时候，更新dom中的class操作。
│   ├── dataset.ts # 在vnode更新的时候，更新dom中的dataset(自定义数据集)操作。
│   ├── eventlisteners.ts  # 在vnode更新的时候，更新dom中的eventlisteners(自定义数据集)操作。
│   ├── hero.ts # 在vnode更新的时候，和动画效果有关的支持
│   ├── module.ts # 定义的module结构
│   ├── props.ts # 在vnode更新的时候，更新dom中的props操作。
│   └── style.js # 在vnode更新的时候，更新dom中的style操作。
├── h.ts   # 帮助函数主要用来操作生成vnode的。
├── hooks.ts   # 定义snabbdom在运行的过程中hooks的模型。    
├── htmldomapi.ts # 对浏览器的dom的api进行二次包装，可以直接操作，html的dom的api。
├── is.ts # is函数主要是针对做一些数据类型判断，分 primitive和array类型。 
├── snabbdom.bundle.ts # snabbdom.ts、attributes、class、props、style 、eventListenersModule和h组成了这个ts文件。
├── snabbdom.ts # 主要文件，程序的主线逻辑都在这个文件里。
├── thunk.ts # thunk这个文件不知道干什么的，但是不影响理解主线逻辑。   
├── tovnode.ts   # 提供了toVNode的方法，把真实dom转化为vnode。
└── vnode.ts # 定义了vnode的模型和转化成为vnode的工具方法。 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>从上面的代码结构，我们可以看到关于snabbdom.js中最主要的代码几个文件是h.ts，snabbdom.ts，tovnode.ts，vnode.ts。</p> <h3 id="vnode-ts"><a href="#vnode-ts" class="header-anchor">#</a> vnode.ts</h3> <p>vnode 是对 DOM 节点的抽象，既然如此，我们很容易定义它的形式：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span>String<span class="token punctuation">,</span> <span class="token comment">// String，DOM 节点的类型，如 'div'/'span'</span>
  data<span class="token operator">:</span>Object<span class="token punctuation">,</span>  <span class="token comment">// Object，包括 props，style等等 DOM 节点的各种属性</span>
  children <span class="token operator">:</span> Array <span class="token comment">// Array，子节点（子 vnode）</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>所以让我们来看下snabbdom.js中对vnode的实际定义又是怎么做的：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNode</span> <span class="token punctuation">{</span>
  sel<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// VNode的选择器，nodeName+id+class的组合</span>
  data<span class="token operator">:</span> VNodeData <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// 存放VNodeData的地方，具体见下面的VNodeData定义</span>
  children<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode <span class="token operator">|</span> <span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// vnode的子vnode的地方</span>
  elm<span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// 存储vnode对应的真实的dom的地方</span>
  text<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// vnode的text文本，和children只能二选一</span>
  key<span class="token operator">:</span> Key <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// vnode的key值，主要用于后续vnode的diff过程</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNodeData</span> <span class="token punctuation">{</span>
  props<span class="token operator">?</span><span class="token operator">:</span> Props<span class="token punctuation">;</span> <span class="token comment">// vnode上传递的其他属性</span>
  attrs<span class="token operator">?</span><span class="token operator">:</span> Attrs<span class="token punctuation">;</span> <span class="token comment">// vnode上的其他dom属性，可以通过setAttribute来设置或删除的。</span>
  <span class="token keyword">class</span><span class="token operator">?</span><span class="token operator">:</span> Classes<span class="token punctuation">;</span> <span class="token comment">// vnode上的class的属性集合</span>
  style<span class="token operator">?</span><span class="token operator">:</span> VNodeStyle<span class="token punctuation">;</span> <span class="token comment">// vnode上的style属性集合</span>
  dataset<span class="token operator">?</span><span class="token operator">:</span> Dataset<span class="token punctuation">;</span> <span class="token comment">// vnode挂载的数据集合</span>
  on<span class="token operator">?</span><span class="token operator">:</span> On<span class="token punctuation">;</span>  <span class="token comment">// 监听的事件集合</span>
  hero<span class="token operator">?</span><span class="token operator">:</span> Hero<span class="token punctuation">;</span> 
  attachData<span class="token operator">?</span><span class="token operator">:</span> AttachData<span class="token punctuation">;</span> <span class="token comment">// 额外附加的数据</span>
  hook<span class="token operator">?</span><span class="token operator">:</span> Hooks<span class="token punctuation">;</span> <span class="token comment">// vnode的钩子函数集合，主要用于在不同阶段调用不通过的钩子函数</span>
  key<span class="token operator">?</span><span class="token operator">:</span> Key<span class="token punctuation">;</span> 
  ns<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> <span class="token comment">// for SVGs 命名空间，主要用于SVG</span>
  fn<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> VNode<span class="token punctuation">;</span> <span class="token comment">// for thunks</span>
  args<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">// for thunks</span>
  <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span> <span class="token comment">// for any other 3rd party module</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>继续往下看我们发现vnode.ts中不仅仅存在Vnode和VnodeData两个数据模型，还有一个vnode的工具方法，用于生成vnode。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 参数是sel，data，children，text，elm，返回值是一个VNode的对象</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
	data<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
	children<span class="token operator">:</span> <span class="token builtin">Array</span> <span class="token operator">&lt;</span> VNode <span class="token operator">|</span> <span class="token builtin">string</span> <span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
	text<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
	elm<span class="token operator">:</span> Element <span class="token operator">|</span> Text <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
	<span class="token keyword">let</span> key <span class="token operator">=</span> data <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> data<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">{</span>
		sel<span class="token operator">:</span> sel<span class="token punctuation">,</span>
		data<span class="token operator">:</span> data<span class="token punctuation">,</span>
		children<span class="token operator">:</span> children<span class="token punctuation">,</span>
		text<span class="token operator">:</span> text<span class="token punctuation">,</span>
		elm<span class="token operator">:</span> elm<span class="token punctuation">,</span>
		key<span class="token operator">:</span> key
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>好了，现在我们已经有 vnode 和一个生成 vnode 的函数，接下来我们看看，如何把真实的 dom 转为 vnode</p> <h3 id="tovnode-ts"><a href="#tovnode-ts" class="header-anchor">#</a> tovnode.ts</h3> <p>真实的dom转为vnode的方法存放在tovnode.ts的文件里，方法名是toVNode。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 参数是要求一个真实的dom对象</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">toVNode</span><span class="token punctuation">(</span>node<span class="token operator">:</span> Node<span class="token punctuation">,</span> domApi<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">DOMAPI</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token comment">// 这边定义了一个变量叫api，主要是一些用于dom操作的api接口。</span>
  <span class="token keyword">const</span> api<span class="token operator">:</span> <span class="token constant">DOMAPI</span> <span class="token operator">=</span> domApi <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> domApi <span class="token operator">:</span> htmlDomApi<span class="token punctuation">;</span>
  <span class="token comment">// 定义了text的变量</span>
  <span class="token keyword">let</span> text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果node是一个element类型的dom对象就进行如下的操作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">isElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获得node的id，变成#id </span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> node<span class="token punctuation">.</span>id <span class="token operator">?</span> <span class="token string">'#'</span> <span class="token operator">+</span> node<span class="token punctuation">.</span>id <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
   <span class="token comment">// 获得class，变成.class1.class2这样的形式</span>
    <span class="token keyword">const</span> cn <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> c <span class="token operator">=</span> cn <span class="token operator">?</span> <span class="token string">'.'</span> <span class="token operator">+</span> cn<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
   <span class="token comment">// sel 变成tagName+id+class的形式，比如&lt;div id=id class=class&gt;&lt;/div&gt;的sel的值就变成了div#id.class</span>
    <span class="token class-name"><span class="token keyword">const</span></span> sel <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">tagName</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> id <span class="token operator">+</span> c<span class="token punctuation">;</span>
   <span class="token comment">// 定义一系列后续需要使用的attrs，children等对象。</span>
    <span class="token keyword">const</span> attrs<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> children<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> n<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    <span class="token comment">// 获得元素里所有的attrs</span>
    <span class="token keyword">const</span> elmAttrs <span class="token operator">=</span> node<span class="token punctuation">.</span>attributes<span class="token punctuation">;</span>
   <span class="token comment">// 获得元素中所有子节点,这边不用children</span>
    <span class="token keyword">const</span> elmChildren <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> elmAttrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      name <span class="token operator">=</span> elmAttrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>nodeName<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> <span class="token string">'id'</span> <span class="token operator">&amp;&amp;</span> name <span class="token operator">!==</span> <span class="token string">'class'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 把非id和class的属性值放到attrs中 </span>
        attrs<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> elmAttrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>nodeValue<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> elmChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过递归的方式把子节点翻译成vnode放入children数组中</span>
      children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">toVNode</span><span class="token punctuation">(</span>elmChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> domApi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token comment">// 生成完整的vnode并返回</span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token punctuation">,</span> <span class="token punctuation">{</span>attrs<span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">isText</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 如果node是一个textContent类型的就返回文本的vnode</span>
    text <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">getTextContent</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">isComment</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 如果node是一个comment类型的就返回sel是&quot;!&quot;的文本的vnode</span>
    text <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">getTextContent</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> node <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果什么都不是就返回一个空的vnode </span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> node <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>OK，现在我们已经知道了如何把一个真实的dom节点转化成为vnode，用js对象的方式生成vnode，可以看到有vnode的方法题目，但是单纯使用vnode函数来创建vnode比较繁琐，所以snabbdom就提供了相应的帮助函数来方便我们创建vnode，在h.ts中。</p> <h3 id="h-ts"><a href="#h-ts" class="header-anchor">#</a> h.ts</h3> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code> <span class="token comment">// 以下所有代码到函数体为止都做了一件事情，对h这个函数进行重载，看不懂的可以去理解下typescript</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span>sel<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span>sel<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> data<span class="token operator">:</span> VNodeData<span class="token punctuation">)</span><span class="token operator">:</span> VNode<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span>sel<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> children<span class="token operator">:</span> VNodeChildren<span class="token punctuation">)</span><span class="token operator">:</span> VNode<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span>sel<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> data<span class="token operator">:</span> VNodeData<span class="token punctuation">,</span> children<span class="token operator">:</span> VNodeChildren<span class="token punctuation">)</span><span class="token operator">:</span> VNode<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span>sel<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> b<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> c<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data<span class="token operator">:</span> VNodeData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> i<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token comment">// 以下一串if判断主要用于规范参数的形式，统一转化。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> children <span class="token operator">=</span> c<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> text <span class="token operator">=</span> c<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span> children <span class="token operator">=</span> <span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> children <span class="token operator">=</span> b<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> text <span class="token operator">=</span> b<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span> children <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span> data <span class="token operator">=</span> b<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token comment">// 对文本或者数字类型的子节点进行转化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 针对svg的node进行特别的处理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    sel<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'s'</span> <span class="token operator">&amp;&amp;</span> sel<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'v'</span> <span class="token operator">&amp;&amp;</span> sel<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'g'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>sel<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">3</span> <span class="token operator">||</span> sel<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'.'</span> <span class="token operator">||</span> sel<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'#'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">addNS</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> sel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token comment">// 返回一个正常的vnode对象。</span>
  <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>以上，我们已经有了各种方法来生成一个vnode，包括从普通js对象生成，从真实的dom来生成。但是我们怎么从vnode生成真实的dom呢？接下来让我们来看看snabbdom.js中最重要的主代码snabbdom.ts。</p> <h3 id="snabbdom-ts"><a href="#snabbdom-ts" class="header-anchor">#</a> snabbdom.ts</h3> <p>利用vnode生成真实dom在snabbdom中主要是通过createElm方法来实现，该方法放在snabbdom.ts中。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">//根据VNode创建element</span>
<span class="token keyword">function</span> <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token operator">:</span> VNodeQueue<span class="token punctuation">)</span><span class="token operator">:</span> Node <span class="token punctuation">{</span>
	<span class="token keyword">let</span> i<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//如果VNodeData存在且hooks里有init函数,则执行init函数,然后重新赋值VNodeData</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
			data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 子虚拟dom,</span>
	<span class="token keyword">let</span> children <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
		sel <span class="token operator">=</span> vnode<span class="token punctuation">.</span>sel<span class="token punctuation">;</span>
	<span class="token comment">// 当sel == &quot;!&quot;的时候表示这个vnode就是一个comment</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sel <span class="token operator">===</span> <span class="token string">'!'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			vnode<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">createComment</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sel <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Parse selector 这么一段就是为了从sel中获得tag值,id值,class值</span>
		<span class="token keyword">const</span> hashIdx <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> dotIdx <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> hashIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> hash <span class="token operator">=</span> hashIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> hashIdx <span class="token operator">:</span> sel<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
		<span class="token keyword">const</span> dot <span class="token operator">=</span> dotIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> dotIdx <span class="token operator">:</span> sel<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
		<span class="token keyword">const</span> tag <span class="token operator">=</span> hashIdx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> dotIdx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> sel<span class="token punctuation">;</span>
		<span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>ns<span class="token punctuation">)</span> <span class="token operator">?</span> api<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> tag<span class="token punctuation">)</span> <span class="token operator">:</span>
			api<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 设置元素的id</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;</span> dot<span class="token punctuation">)</span> elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hash <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 设置元素的class</span>
		<span class="token class-name"><span class="token keyword">if</span></span> <span class="token punctuation">(</span>dotIdx <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>dot <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 调用create钩子</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> ch <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">//深度遍历</span>
					api<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>ch <span class="token keyword">as</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			api<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		i <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>hook<span class="token punctuation">;</span> <span class="token comment">// Reuse variable</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>create<span class="token punctuation">)</span> i<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//当insert的hook存在,就在插入Vnode的队列中加入该vnode</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>insert<span class="token punctuation">)</span> insertedVnodeQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// 其他的情况就当vnode是一个简单的TextNode</span>
		vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>OK到现在为止，我们已经把complie的阶段弄的差不多了，现在只剩下，怎么比较 oldVnode 与 newVnode 两个 vnode，并实现 DOM 树更新？也就是我们前面提到的diff方法和patch过程，在snabbdom.ts，diff和patch都写在一起，我们继续往下看。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// patch过程</span>
<span class="token keyword">function</span> <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token operator">:</span> VNodeQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> i<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> hook<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
	<span class="token comment">// 调用全局hook里定义的事件的地方。</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>hook <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> hook<span class="token punctuation">.</span>prepatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 因为 vnode 和 oldVnode 是相同的 vnode，所以我们可以复用 oldVnode.elm。</span>
	<span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
	<span class="token keyword">let</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 如果 vnode.text 是 undefined</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 核心逻辑（最复杂的地方）：怎么比较新旧 children 并更新，对应上面</span>
			<span class="token comment">// 的数组比较</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh <span class="token keyword">as</span> <span class="token builtin">Array</span> <span class="token operator">&lt;</span> VNode <span class="token operator">&gt;</span> <span class="token punctuation">,</span> ch <span class="token keyword">as</span> <span class="token builtin">Array</span> <span class="token operator">&lt;</span> VNode <span class="token operator">&gt;</span> <span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 添加新 children</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 首先删除原来的 text</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 然后添加新 dom（对 ch 中每个 vnode 递归创建 dom 并插入到 elm）</span>
			<span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch <span class="token keyword">as</span> <span class="token builtin">Array</span> <span class="token operator">&lt;</span> VNode <span class="token operator">&gt;</span> <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ch <span class="token keyword">as</span> <span class="token builtin">Array</span> <span class="token operator">&lt;</span> VNode <span class="token operator">&gt;</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 相反地，如果原来有 children 而现在没有，那么我们要删除 children。</span>
			<span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh <span class="token keyword">as</span> <span class="token builtin">Array</span> <span class="token operator">&lt;</span> VNode <span class="token operator">&gt;</span> <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>oldCh <span class="token keyword">as</span> <span class="token builtin">Array</span> <span class="token operator">&lt;</span> VNode <span class="token operator">&gt;</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 最后，如果 oldVnode 有 text，删除。</span>
			api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 否则 （vnode 有 text），只要 text 不等，更新 dom 的 text。</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> hook<span class="token punctuation">.</span>postpatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// diff算法的重点</span>
<span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>parentElm<span class="token operator">:</span> Node<span class="token punctuation">,</span>
	oldCh<span class="token operator">:</span> <span class="token builtin">Array</span> <span class="token operator">&lt;</span> VNode <span class="token operator">&gt;</span> <span class="token punctuation">,</span>
	newCh<span class="token operator">:</span> <span class="token builtin">Array</span> <span class="token operator">&lt;</span> VNode <span class="token operator">&gt;</span> <span class="token punctuation">,</span>
	insertedVnodeQueue<span class="token operator">:</span> VNodeQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// parentElm:Node</span>
	<span class="token comment">// oldCh: Array&lt;VNode&gt;</span>
	<span class="token comment">// newCh: Array&lt;VNode&gt;</span>
	<span class="token comment">// insertdVnodeQuenen: VNodeQuenen</span>
	<span class="token comment">// 和patchVnode形成了精巧递归</span>
	<span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
		newStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> oldKeyToIdx<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> idxInOld<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> elmToMove<span class="token operator">:</span> VNode<span class="token punctuation">;</span>
	<span class="token keyword">let</span> before<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>

	<span class="token comment">// 当oldCh和newCh其中还有一个没有比较完的话，就执行下的函数</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Vnode might have been moved left</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
			oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
			newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
			oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
			newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved right</span>
			<span class="token comment">// 把获得更新后的 (oldStartVnode/newEndVnode) 的 dom 右移，移动到</span>
			<span class="token comment">// oldEndVnode 对应的 dom 的右边。为什么这么右移？</span>
			<span class="token comment">// （1）oldStartVnode 和 newEndVnode 相同，显然是 vnode 右移了。</span>
			<span class="token comment">// （2）若 while 循环刚开始，那移到 oldEndVnode.elm 右边就是最右边，是合理的；</span>
			<span class="token comment">// （3）若循环不是刚开始，因为比较过程是两头向中间，那么两头的 dom 的位置已经是</span>
			<span class="token comment">//     合理的了，移动到 oldEndVnode.elm 右边是正确的位置；</span>
			<span class="token comment">// （4）记住，oldVnode 和 vnode 是相同的才 patch，且 oldVnode 自己对应的 dom</span>
			<span class="token comment">//     总是已经存在的，vnode 的 dom 是不存在的，直接复用 oldVnode 对应的 dom。</span>
			<span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
			api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
			newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved left</span>
			<span class="token comment">//更新新旧vnode的值，然后vnode左移</span>
			<span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
			api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">;</span>
			oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
			newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>oldKeyToIdx <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			idxInOld <span class="token operator">=</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token comment">// 新的children中的startVnode元素没有在旧children中找到</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// New element</span>
				api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">;</span>
				newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// 新的children中的startNode元素在旧children中找到元素</span>
				elmToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token comment">// 如果sel不相等则必须重新创建一个新的ele</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>elmToMove<span class="token punctuation">.</span>sel <span class="token operator">!==</span> newStartVnode<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token comment">// 更新操作</span>
					<span class="token function">patchVnode</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
					oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
					api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">(</span>elmToMove<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br></div></div><p>在上述的操作中，有一个重要的函数叫sameVnode，十分重要，对diff算法的影响十分巨大，通常情况下，找到两棵任意的树之间最小修改的时间复杂度是 O(n^3)，这不可接受。幸好，我们可以对 Virtual DOM 树有这样的假设：
如果 oldVnode 和 vnode 不同（如 type 从 div 变到 p，或者 key 改变），意味着整个 vnode 被替换（因为我们通常不会去跨层移动 vnode ），所以我们没有必要去比较 vnode 的 子 vnode（children） 了。基于这个假设，我们可以 按照层级分解 树，这大大简化了复杂度，大到接近 O(n) 的复杂度：</p> <p>此外，对于 children （数组）的比较，因为同层是很可能有移动的，顺序比较会无法最大化复用已有的 DOM。所以我们通过为每个 vnode 加上 key 来追踪这种顺序变动。</p> <p>这部分内容摘自<a href="https://www.jianshu.com/p/1f1ef915e83e" target="_blank" rel="noopener noreferrer">Virtual DOM和snabbdom.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>整理一下 snabbdom库 中的重要文件及功能：</p> <ul><li>vnode.ts 定义了vnode的模型和转化成为vnode的工具方法</li> <li>tovnode.ts，提供了toVNode的方法，把真实dom转化为vnode</li> <li>h.ts，帮助函数主要用来操作生成vnode的</li> <li>snabbdom.ts，vnode生成真实的dom</li></ul> <h2 id="_5-小结"><a href="#_5-小结" class="header-anchor">#</a> 5. 小结</h2> <p><strong>参考：</strong></p> <p><a href="https://www.jianshu.com/p/1f1ef915e83e" target="_blank" rel="noopener noreferrer">Virtual DOM和snabbdom.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://coding.imooc.com/class/190.html" target="_blank" rel="noopener noreferrer">前端JavaScript高级面试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>下一步学习计划：</strong></p> <p>从 vue 源码中 学习其实现 vdom 的方式。</p> <p>vdom 的实现，比较难理解的就是 diff 算法，其中还涉及到对树这种数据结构的一些处理，之前虽然通过《学习JavaScript数据结构与算法》对数据结构进行学习，但还只是入门阶段，这次正好深入学习，然后再去看源码，相信这样一定可以对 vdom 的实现有更好的理解。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Chrislin-jiang/code-girl/edit/master/docs/framework/vue/42-虚拟DOM.md" target="_blank" rel="noopener noreferrer">编辑文档！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021年10月30日星期六晚上8点03分</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/code-girl/framework/vue/41-数据绑定.html" class="prev">
        数据绑定
      </a></span> <span class="next"><a href="/code-girl/framework/vue/43-模板编译.html">
        模板编译
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/code-girl/assets/js/app.223cac8a.js" defer></script><script src="/code-girl/assets/js/2.d9d6c442.js" defer></script><script src="/code-girl/assets/js/75.02b082d9.js" defer></script><script src="/code-girl/assets/js/3.a7958272.js" defer></script>
  </body>
</html>
